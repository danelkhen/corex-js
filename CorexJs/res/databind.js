/* Generated by SharpKit 5 v5.4.4 */
if (typeof ($Inherit) == 'undefined') {
	var $Inherit = function (ce, ce2) {

		if (typeof (Object.getOwnPropertyNames) == 'undefined') {

			for (var p in ce2.prototype)
				if (typeof (ce.prototype[p]) == 'undefined' || ce.prototype[p] == Object.prototype[p])
					ce.prototype[p] = ce2.prototype[p];
			for (var p in ce2)
				if (typeof (ce[p]) == 'undefined')
					ce[p] = ce2[p];
			ce.$baseCtor = ce2;

		} else {

			var props = Object.getOwnPropertyNames(ce2.prototype);
			for (var i = 0; i < props.length; i++)
				if (typeof (Object.getOwnPropertyDescriptor(ce.prototype, props[i])) == 'undefined')
					Object.defineProperty(ce.prototype, props[i], Object.getOwnPropertyDescriptor(ce2.prototype, props[i]));

			for (var p in ce2)
				if (typeof (ce[p]) == 'undefined')
					ce[p] = ce2[p];
			ce.$baseCtor = ce2;

		}

	}
};

if (typeof ($CreateAnonymousDelegate) == 'undefined') {
    var $CreateAnonymousDelegate = function (target, func) {
        if (target == null || func == null)
            return func;
        var delegate = function () {
            return func.apply(target, arguments);
        };
        delegate.func = func;
        delegate.target = target;
        delegate.isDelegate = true;
        return delegate;
    }
}

if (typeof($CreateDelegate)=='undefined'){
    if(typeof($iKey)=='undefined') var $iKey = 0;
    if(typeof($pKey)=='undefined') var $pKey = String.fromCharCode(1);
    var $CreateDelegate = function(target, func){
        if (target == null || func == null) 
            return func;
        if(func.target==target && func.func==func)
            return func;
        if (target.$delegateCache == null)
            target.$delegateCache = {};
        if (func.$key == null)
            func.$key = $pKey + String(++$iKey);
        var delegate;
        if(target.$delegateCache!=null)
            delegate = target.$delegateCache[func.$key];
        if (delegate == null){
            delegate = function(){
                return func.apply(target, arguments);
            };
            delegate.func = func;
            delegate.target = target;
            delegate.isDelegate = true;
            if(target.$delegateCache!=null)
                target.$delegateCache[func.$key] = delegate;
        }
        return delegate;
    }
}


if (typeof(C) == "undefined")
    var C = {};
if (typeof(C.DataBinding) == "undefined")
    C.DataBinding = {};
C.DataBinding.BaseBinder = function (oneway){
    this.inited = false;
    this.oneway = false;
    this.CustomSource = null;
    this.oneway = oneway;
};
C.DataBinding.BaseBinder.prototype.verifyInit = function (e){
    if (this.inited)
        return;
    this.init(e);
};
C.DataBinding.BaseBinder.prototype.init = function (e){
    if (this.inited){
        console.log("already inited");
        return;
    }
    this.inited = true;
};
C.DataBinding.BaseBinder.prototype.databind = function (e){
    this.verifyInit(e);
    this.onTransfer(this.getSource(e), this.getTarget(e));
};
C.DataBinding.BaseBinder.prototype.databindback = function (e){
    if (this.oneway)
        return;
    this.verifyInit(e);
    this.onTransferBack(this.getSource(e), this.getTarget(e));
};
C.DataBinding.BaseBinder.prototype.getTarget = function (e){
    return e.target;
};
C.DataBinding.BaseBinder.prototype.getSource = function (e){
    if (this.CustomSource != null)
        return this.CustomSource;
    return $(e.target).datasource();
};
C.DataBinding.BaseBinder.prototype.datasource = function (obj){
    this.CustomSource = obj;
    return this;
};
C.DataBinding.BaseBinder.prototype.onTransfer = function (source, target){
};
C.DataBinding.BaseBinder.prototype.onTransferBack = function (source, target){
};
C.DataBinding.BindersContext = function (){
};
C.DataBinding.BindersContext.prototype.oneway = function (source, target){
    return new C.DataBinding.PathBinder(source, target, true, null);
};
C.DataBinding.BindersContext.prototype.onewayonchange = function (source, target){
    return new C.DataBinding.PathBinder(source, target, true, "change");
};
C.DataBinding.BindersContext.prototype.twoway = function (source, target){
    return new C.DataBinding.PathBinder(source, target, false, null);
};
C.DataBinding.BindersContext.prototype.onchange = function (source, target){
    return new C.DataBinding.PathBinder(source, target, false, "change");
};
C.DataBinding.BindersContext.prototype.children = function (source){
    return new C.DataBinding.ChildrenBinder(source);
};
C.DataBinding.BindersContext.prototype.toggleclass = function (source, className, oneway, triggers){
    return new C.DataBinding.ToggleClassBinder(source, className, oneway, triggers);
};
C.DataBinding.BindersContext.prototype.toggleclassoneway = function (source, className, triggers){
    return new C.DataBinding.ToggleClassBinder(source, className, true, triggers);
};
C.DataBinding.ChildrenBinder = function (sourcePath){
    this.sourcePath = null;
    this.CustomSource = null;
    this.sourcePath = sourcePath;
};
C.DataBinding.ChildrenBinder.prototype.databind = function (e){
    var source = this.getSource(e);
    C.DataBinding.ChildrenBinder.bindArrayToChildren($(e.target), null, BindingExt.tryGetByPath(source, this.sourcePath));
};
C.DataBinding.ChildrenBinder.prototype.getSource = function (e){
    if (this.CustomSource != null)
        return this.CustomSource;
    return $(e.target).datasource();
};
C.DataBinding.ChildrenBinder.prototype.datasource = function (obj){
    this.CustomSource = obj;
    return this;
};
C.DataBinding.ChildrenBinder.prototype.databindback = function (e){
};
C.DataBinding.ChildrenBinder.bindArrayToChildren = function (target, template, source){
    var list = source;
    var el2 = $(target);
    var template2 = $(template);
    if (template2.length == 0)
        template2 = el2.children(".Template:first");
    if (template2.length == 0)
        return;
    if (list == null)
        list = el2.data("source");
    if (!(list instanceof Array))
        return;
    var children = el2.children(":not(.Template)").toArray();
    var createTemplate = function (t){
        return template2.clone(true).removeClass("Template").datasource(t);
    };
    C.DataBinding.ChildrenBinder.bindArrayToChildrenInternal(list, el2, children, createTemplate);
    el2.children(":not(.Template)").databind();
};
C.DataBinding.ChildrenBinder.bindArrayToChildrenInternal = function (source, target, children, creator){
    var index = 0;
    var index2 = 0;
    while (index2 < children.length){
        var ch2 = $(children[index2]);
        var dc2 = ch2.data("source");
        if (dc2 == null){
            index2++;
            continue;
        }
        var dc = source[index];
        if (dc != dc2){
            if (dc == null){
                ch2.remove();
                index2++;
                continue;
            }
            else {
                var ch3 = creator(dc);
                ch3.insertBefore(ch2);
                index++;
                continue;
            }
        }
        index2++;
        index++;
    }
    while (index < source.length){
        target.append(creator(source[index]));
        index++;
    }
};
C.DataBinding.PropertyBinder = function (source, target, oneway){
    this.sourceProp = null;
    this.targetProp = null;
    C.DataBinding.BaseBinder.call(this, oneway);
    this.sourceProp = source;
    this.targetProp = target;
    this.oneway = oneway;
};
C.DataBinding.PropertyBinder.prototype.onTransfer = function (source, target){
    var value = this.sourceProp.get(source);
    this.targetProp.set(target, value);
    console.log("onTransfer", source, target, value);
};
C.DataBinding.PropertyBinder.prototype.onTransferBack = function (source, target){
    var value = this.targetProp.get(target);
    this.sourceProp.set(source, value);
    console.log("onTransferBack", source, target, value);
};
$Inherit(C.DataBinding.PropertyBinder, C.DataBinding.BaseBinder);
C.DataBinding.PathBinder = function (source, target, oneWay, triggers){
    this.sourcePath = null;
    this.targetPath = null;
    this.triggers = null;
    C.DataBinding.PropertyBinder.call(this);
    this.sourcePath = source;
    this.targetPath = target;
    this.oneway = oneWay;
    this.triggers = triggers;
};
C.DataBinding.PathBinder.prototype.init = function (e){
    C.DataBinding.BaseBinder.prototype.init.call(this, e);
    if (Q.isNullOrEmpty(this.targetPath))
        this.targetPath = C.DataBinding.PathBinder.getDefaultTargetPath(e.target);
    this.sourceProp = this.createProperty(this.sourcePath);
    this.targetProp = this.createProperty(this.targetPath);
    if (this.triggers != null && this.triggers.length > 0){
        var target = $(e.target);
        target.on(this.triggers, $CreateDelegate(this, this.onTrigger));
    }
};
C.DataBinding.PathBinder.prototype.createProperty = function (path){
    return {
        get: $CreateAnonymousDelegate(this, function (t){
            return BindingExt.tryGetByPath(t, path);
        }),
        set: $CreateAnonymousDelegate(this, function (t, v){
            Object.trySet(t, path, v);
        })
    };
};
C.DataBinding.PathBinder.prototype.onTrigger = function (e){
    console.log("Trigger: " + e.type);
    if (this.oneway)
        this.databind(e);
    else
        this.databindback(e);
};
C.DataBinding.PathBinder.prototype.destroy = function (e){
    if (this.triggers != null && this.triggers.length > 0){
        var target = $(e.target);
        target.off(this.triggers, $CreateDelegate(this, this.databindback));
    }
};
C.DataBinding.PathBinder.getDefaultTargetPath = function (el){
    if (el.nodeName == "INPUT"){
        if (["radio", "checkbox"].contains(el.type))
            return "checked";
    }
    return "value";
};
$Inherit(C.DataBinding.PathBinder, C.DataBinding.PropertyBinder);
C.DataBinding.Plugin = function (){
};
C.DataBinding.Plugin.databindflat = function (q){
    C.DataBinding.Plugin.triggerDataBindingEvent(q, "databind", {
        flat: true
    }, "onbind", C.DataBinding.Plugin.element_databind_default);
    return q;
};
C.DataBinding.Plugin.databind = function (q){
    C.DataBinding.Plugin.triggerDataBindingEvent(q, "databind", null, "onbind", C.DataBinding.Plugin.element_databind_default);
    return q;
};
C.DataBinding.Plugin.databindback = function (q){
    C.DataBinding.Plugin.triggerDataBindingEvent(q, "databindback", null, "onbindback", C.DataBinding.Plugin.element_databindback_default);
    return q;
};
C.DataBinding.Plugin.addBinder = function (q, binder){
    var binders = C.DataBinding.Plugin.ProcessAndGetDataAttribute(q, "binders", C.DataBinding.Plugin.evalBinders);
    if (binders == null){
        binders =  [];
        q.data("binders", binders);
    }
    binders.push(binder);
    return q;
};
C.DataBinding.Plugin.set_datasource = function (q, source){
    return q.data("source", source);
};
C.DataBinding.Plugin.get_datasource = function (q){
    return C.DataBinding.Plugin.ProcessAndGetDataAttribute(q, "source", C.DataBinding.Plugin.evalDataSource);
};
C.DataBinding.Plugin.ProcessAndGetDataAttribute = function (q, name, processor){
    var x = q.data(name);
    if (x == null)
        return null;
    if (typeof(x) == "string" && q.attr("data-" + name) == x){
        var value = processor(x);
        q.data(name, value);
        return value;
    }
    return x;
};
C.DataBinding.Plugin.evalDataSource = function (code){
    if (!code.contains("return"))
        code = "return " + code;
    var ctx = new C.DataBinding.BindersContext();
    var func = new Function(code);
    var res = func.call(null);
    return res;
};
C.DataBinding.Plugin.evalBinders = function (code){
    if (!code.contains("return"))
        code = "return " + code;
    var ctx = new C.DataBinding.BindersContext();
    code = "with(ctx){" + code + "}";
    var func = new Function("ctx", code);
    var res = func.call(null, ctx);
    return res;
};
C.DataBinding.Plugin.element_setup_default = function (e){
    var target = $(e.target);
    var binders2 = C.DataBinding.Plugin.ProcessAndGetDataAttribute(target, "bindings", C.DataBinding.Plugin.parseBindings);
    var binders = C.DataBinding.Plugin.ProcessAndGetDataAttribute(target, "binders", C.DataBinding.Plugin.evalBinders);
    if (binders2 != null){
        if (binders == null){
            binders =  [];
            target.data("binders", binders);
        }
        binders.addRange(binders2);
    }
};
C.DataBinding.Plugin.element_teardown_default = function (e){
    var target = $(e.target);
    var binders = target.data("binders");
    if (binders != null){
        binders.forEach(function (t){
            t.destroy(e);
        });
        target.removeData("binders");
    }
};
C.DataBinding.Plugin.isinited = function (target){
    return target.data("databind-isinited") === true;
};
C.DataBinding.Plugin.set_isinited = function (target){
    target.data("databind-isinited", true);
};
C.DataBinding.Plugin.verifyInit = function (el){
    var target = $(el);
    var isInited = C.DataBinding.Plugin.isinited(target);
    if (!isInited){
        C.DataBinding.Plugin.set_isinited(target);
        C.DataBinding.Plugin.triggerDataBindingEvent(target, "init", null, "oninit", C.DataBinding.Plugin.element_setup_default);
    }
};
C.DataBinding.Plugin.element_databind_default = function (e){
    C.DataBinding.Plugin.verifyInit(e.target);
    var target = $(e.target);
    console.log(e.type, e.target.nodeName, e.target.className, JSON.stringify(target.datasource()));
    var dataSource = target.datasource();
    var dataMember = target.data("member");
    var binders = target.data("binders");
    if (binders != null){
        binders.forEach(function (t){
            t.databind(e);
        });
    }
    if (e.flat)
        return;
    var children = target.children(":not(.Template)");
    var childSource = dataSource;
    if (childSource != null && dataMember != null)
        childSource = childSource[dataMember];
    children.toArray().forEach(function (t){
        var t2 = $(t);
        var ctx = t2.datasource();
        if (ctx == null || t2.data("inherited-source") == ctx){
            t2.datasource(childSource);
            t2.data("inherited-source", childSource);
        }
    });
    children.databind();
};
C.DataBinding.Plugin.element_databindback_default = function (e){
    C.DataBinding.Plugin.verifyInit(e.target);
    var target = $(e.target);
    var dataSource = target.datasource();
    var binders = target.data("binders");
    if (binders != null)
        binders.forEach(function (t){
            t.databindback(e);
        });
    target.children(":not(.Template)").databindback();
};
C.DataBinding.Plugin.parseBindings = function (s){
    return null;
};
C.DataBinding.Plugin.parseStyleAttr = function (s){
    if (s == null || s == "")
        return null;
    var pairs = s.split(";");
    var obj = new Object();
    pairs.forEach(function (pair){
        if (pair == "")
            return;
        var pair2 = pair.split(":");
        obj[pair2[0]] = pair2[1];
    });
    return obj;
};
C.DataBinding.Plugin.triggerDataBindingEvent = function (q, type, props, attrName, defaultBehavior){
    q.each(function (i, el){
        var ev = new jQuery.Event(type, props);
        C.DataBinding.Plugin.triggerDataBindingAttrEvent(ev, attrName, el);
        if (ev.isDefaultPrevented())
            return;
        var target = $(el);
        target.triggerHandler(ev);
        if (ev.isDefaultPrevented())
            return;
        defaultBehavior(ev);
    });
};
C.DataBinding.Plugin.triggerDataBindingAttrEvent = function (e, attrName, el){
    var target = $(el);
    var context = {
        source: target.datasource(),
        member: target.data("member")
    };
    e.target = el;
    C.DataBinding.Plugin.triggerAttributeEvent(e, attrName, context);
};
C.DataBinding.Plugin.triggerAttributeEvent = function (e, attrName, globalContext){
    var target = $(e.target);
    var att = target.data(attrName);
    if (att == null)
        return;
    var func = null;
    try{
        func = new Function("event", "context", "with(context){" + att + "}");
    }
    catch(ee){
        console.warn(ee, att);
        return;
    }
    var returnValue = func.call(e.target, e, globalContext);
    if (!e.isDefaultPrevented() && returnValue === false)
        e.preventDefault();
};
var BindingExt = function (){
};
BindingExt.tryGetByPath = function (obj, path){
    if (path == null || path == "")
        return obj;
    return Object.tryGet(obj, path);
};
$.fn.databind = function (){
    return C.DataBinding.Plugin.databind(this);
};
$.fn.databindflat = function (){
    return C.DataBinding.Plugin.databindflat(this);
};
$.fn.databindback = function (){
    return C.DataBinding.Plugin.databindback(this);
};
$.fn.addBinder = function (binder){
    return C.DataBinding.Plugin.addBinder(this, binder);
};
$.fn.dataparent = function (){
    var source = this.data("source");
    var prev = this;
    var el = this.parent();
    while (el.length > 0){
        if (el.data("source") != source)
            break;
        prev = el;
        el = el.parent();
    }
    return prev;
};
$.fn.datasource = function (source){
    if (arguments.length == 0)
        return C.DataBinding.Plugin.get_datasource(this);
    return C.DataBinding.Plugin.set_datasource(this, source);
};
$.fn.wheredatasource = function (obj){
    return this.filter($CreateAnonymousDelegate(this, function (i, el){
        return $(el).datasource() == obj;
    }));
};
C.DataBinding.ToggleClassBinder = function (source, className, oneWay, triggers){
    this.className = null;
    C.DataBinding.PathBinder.call(this, source, null, oneWay, triggers);
    this.className = className;
};
C.DataBinding.ToggleClassBinder.prototype.init = function (e){
    C.DataBinding.PathBinder.prototype.init.call(this, e);
    this.targetProp = {
        get: $CreateAnonymousDelegate(this, function (t){
            return $(t).hasClass(this.className);
        }),
        set: $CreateAnonymousDelegate(this, function (t, v){
            $(t).toggleClass(this.className, v);
        })
    };
};
$Inherit(C.DataBinding.ToggleClassBinder, C.DataBinding.PathBinder);

