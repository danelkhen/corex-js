/* Generated by SharpKit 5 v5.4.4 */

(function(){
init();
function init(){
    $(document).on("databind", document_databind);
    $(document).on("databindback", document_databindback);
};
function document_databind(e){
    if (e.isDefaultPrevented())
        return;
    var target = $(e.target);
    var dataContext = target.data("context");
    var dataMember = target.data("member");
    var att = $(e.target).data("onbind");
    if (att != null){
        var func = new Function("event", "context", "member", att);
        var returnValue = func.call(e.target, e, dataContext, dataMember);
        if (!e.isDefaultPrevented() && returnValue === false){
            e.preventDefault();
            return;
        }
    }
    var bindings = parseBindings2($(e.target).data("bindings"), getDefaultBindingTarget(e.target));
    if (bindings != null){
        databind_bind(dataContext, e.target, bindings);
    }
    var children = target.children(":not(.Template)");
    var childDataContext = dataContext;
    if (childDataContext != null && dataMember != null)
        childDataContext = childDataContext[dataMember];
    children.toArray().forEach(function (t){
        var t2 = $(t);
        var ctx = t2.data("context");
        if (ctx == null || t2.data("inherited-context") == ctx){
            t2.data("context", childDataContext);
            t2.data("inherited-context", childDataContext);
        }
        else {
            console.log();
        }
    });
    children.databind();
};
function databind_bind(source, target, bindings){
    if (bindings == null || target == null || source == null)
        return;
    bindings.forEach(function (t){
        if (t.TargetPath == "children"){
            bindArrayToChildren(target, null, Object.tryGet(source, t.SourcePath));
        }
        else {
            databind_tryCopy(source, t.SourcePath, target, t.TargetPath);
        }
    });
};
function databind_bindBack(source, target, bindings){
    bindings.forEach(function (t){
        databind_tryCopy(target, t.TargetPath, source, t.SourcePath);
    });
};
function databind_tryCopy(source, sourcePath, target, targetPath){
    var value = Object.tryGet(source, sourcePath);
    Object.trySet(target, targetPath, value);
};
function document_databindback(e){
    if (e.isDefaultPrevented())
        return;
    var target = $(e.target);
    var dataContext = target.data("context");
    var dataMember = target.data("member");
    var att = $(e.target).data("onbindback");
    if (att != null){
        var func = new Function("event", "context", "member", att);
        var returnValue = func.call(e.target, e, dataContext, dataMember);
        if (!e.isDefaultPrevented() && returnValue === false){
            e.preventDefault();
            return;
        }
    }
    var bindings = parseBindings2($(e.target).data("bindings"), getDefaultBindingTarget(e.target));
    if (bindings != null){
        databind_bindBack(dataContext, e.target, bindings);
    }
    target.children(":not(.Template)").databindback();
};
function bindArrayToChildren(el, template, context){
    var list = context;
    var el2 = $(el);
    var template2 = $(template);
    if (template2.length == 0)
        template2 = el2.find(".Template:first");
    if (template2.length == 0)
        return;
    if (list == null)
        list = el2.data("context");
    if (!(list instanceof Array))
        return;
    var children = el2.children(":not(.Template)").toArray();
    var createTemplate = function (t){
        return template2.clone(true).removeClass("Template").data("context", t);
    };
    bindArrayToChildrenInternal(list, el2, children, createTemplate);
};
function bindArrayToChildrenInternal(source, target, children, creator){
    var index = 0;
    var index2 = 0;
    while (index2 < children.length){
        var ch2 = $(children[index2]);
        var dc2 = ch2.data("context");
        if (dc2 == null)
            continue;
        var dc = source[index];
        if (dc != dc2){
            if (dc == null){
                ch2.remove();
                index2++;
                continue;
            }
            else {
                var ch3 = creator(dc);
                ch3.insertBefore(ch2);
                index++;
                continue;
            }
        }
        index2++;
        index++;
    }
    while (index < source.length){
        target.append(creator(source[index]));
        index++;
    }
};
function getDefaultBindingTarget(el){
    if (el.nodeName == "INPUT"){
        if (["radio", "checkbox"].contains(el.type))
            return "checked";
    }
    return "value";
};
function parseBindings2(s, defaultTarget){
    if (s == null || s == "")
        return null;
    var pairs = s.split(";");
    var list =  [];
    pairs.forEach(function (pair){
        if (pair == "")
            return;
        var pair2 = pair.split(":");
        var b = {
            SourcePath: pair2[0],
            TargetPath: (pair2[1] != null ? pair2[1] : defaultTarget)
        };
        list.push(b);
    });
    return list;
};
})();
$.fn.databind = function (){
    this.trigger("databind");
    return this;
};
$.fn.databindback = function (){
    this.trigger("databindback");
    return this;
};

